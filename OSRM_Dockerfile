# This is based on a base OSRM with more alternative routes set to appear.
FROM linusmotu/osrm-more-alt-linux:transitwebapp
WORKDIR /

ENV PORT=8080
ARG SPEED_FILE
ARG PBF_FILE
COPY $PBF_FILE /media/location_file.osm.pbf
COPY $SPEED_FILE /media/speed_file.csv

# RUN /usr/local/bin/osrm-extract -p /opt/car.lua /media/location_file.osm.pbf
# RUN /usr/local/bin/osrm-partition  /media/location_file.osrm
# RUN /usr/local/bin/osrm-customize  /media/location_file.osrm

# RUN /usr/local/bin/osrm-contract /media/location_file.osrm --segment-speed-file /media/speed_file.csv

EXPOSE ${PORT}
# Allow larger table query sizes
RUN echo "/usr/local/bin/osrm-routed --port ${PORT} --algorithm mld --max-alternatives 10 --max-matching-size 10000 --max-viaroute-size 100 --max-trip-size 10000 --max-nearest-size 10000 --max-table-size 10000 /media/location_file.osrm" > start.sh \
    && chmod u+x start.sh

CMD ["sh", "-c", "./start.sh" ]
